---
title: "Rescaling of cell and genes features"
author: "Benjamin Arthur"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Batch Integration with Linked NMF}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


## Introduction

The purpose of this package is to rescale cell or gene features from a seurat object which has been normalized and RunNMF has being implemented.

The library and object for rescaling can be found in the singlet package.

```{r}
library(singlet)
library(ggplot2)
library(dplyr)
library(cowplot)
pbmc3k <- get_pbmc3k_data()
pbmc3k <- pbmc3k %>% NormalizeData() %>% RunNMF(reps = 1)
```

Since we are having technical issues with the package i would used the source code for these examples 

```{r}
rescale_nmf <- function(object, features, lambda = 0.5, reduction.key = "nmf_rescaled"){
  nmf_model <- object@reductions$nmf
  is_w <- sum(features %in% rownames(nmf_model@feature.loadings))
  is_h <- sum(features %in% rownames(nmf_model@cell.embeddings))
  if(is_w > is_h){
    # rescale w
    w <- nmf_model@feature.loadings
    h <- nmf_model@cell.embeddings
    v <- colSums(w[which(rownames(w) %in% features), ])
    v <- v / mean(v)
    v <- lambda * v + (1 - lambda) * rep(1, length(v))
    nmf_model@feature.loadings <- as.matrix(w %*% Matrix::Diagonal(x = v))
    nmf_model@cell.embeddings <- as.matrix(h %*% Matrix::Diagonal(x = v))
    object@reductions[[reduction.key]] <- nmf_model
    object
  } else {
    w <- nmf_model@feature.loadings
    h <- nmf_model@cell.embeddings
    v <- colSums(h[which(rownames(h) %in% features), ])
    v <- v / mean(v)
    v <- lambda * v + (1 - lambda) * rep(1, length(v))
    nmf_model@feature.loadings <- as.matrix(w %*% Matrix::Diagonal(x = v))
    nmf_model@cell.embeddings <- as.matrix(h %*% Matrix::Diagonal(x = v))
    object@reductions[[reduction.key]] <- nmf_model
    object
  }
}
```

## Recaling of a gene features with different threshold (Lambda)

In this example we used four genes of interest with 0.8 threshold, and we assume that using a threshold which is close to 1, the relationship between v and H would reduce.

From the plots below, the first UMAP visualized the genes features after rescaling and the second UMAP is visualizing the genes features with recaling.
```{r}
set.seed(542)
# Cell.embedding
cell = c("AACCGCCTCTACGAA","AACCTACTGTGAGG","AACCAGTGATACCG","AACACGTGGAAAGT")
cellem <- rescale_nmf(pbmc3k,cell,0.8,reduction.key = "nmf_rescaled")



cell_model <- RunUMAP(cellem, reduction = "nmf_rescaled", reduction.name = "umap_nmf_rescaled", dims = 1:ncol(cellem@reductions$nmf@feature.loadings))

pbmc3k_model <- RunUMAP(pbmc3k, reduction = "nmf", reduction.name = "umap_nmf", dims = 1:ncol(pbmc3k@reductions$nmf@feature.loadings))


plot_grid(DimPlot(pbmc3k_model, reduction = "umap_nmf", group.by = "cell_type"), DimPlot(cell_model, reduction = "umap_nmf_rescaled", group.by = "cell_type"), ncol = 2)

```

Using threshold of about 0.2

```{r}
set.seed(542)
# Cell.embedding
cell = c("AACCGCCTCTACGAA","AACCTACTGTGAGG","AACCAGTGATACCG","AACACGTGGAAAGT")
cellem <- rescale_nmf(pbmc3k,cell,0.2,reduction.key = "nmf_rescaled")



cell_model <- RunUMAP(cellem, reduction = "nmf_rescaled", reduction.name = "umap_nmf_rescaled", dims = 1:ncol(cellem@reductions$nmf@feature.loadings))

pbmc3k_model <- RunUMAP(pbmc3k, reduction = "nmf", reduction.name = "umap_nmf", dims = 1:ncol(pbmc3k@reductions$nmf@feature.loadings))


plot_grid(DimPlot(pbmc3k_model, reduction = "umap_nmf", group.by = "cell_type"), DimPlot(cell_model, reduction = "umap_nmf_rescaled", group.by = "cell_type"), ncol = 2)

```



## Recaling of a cell features with different threshold (Lambda)

In this example , we would checking the relationship between some selected genes (V) and
the H matrix from the reduction. Using threshold of 0.7.

From the plots below, the first UMAP visualized the cell features after rescaling and the second UMAP is visualizing the cells features with rescaling.
```{r}

# Feature.loading 
feat = c('AGRN','ACAP3','DVL1')
scaall<- rescale_nmf(pbmc3k,feat,0.7,reduction.key = "nmf_rescaled")
str(scaall)


scaally <- RunUMAP(scaall, reduction = "nmf_rescaled", reduction.name = "umap_nmf_rescaled", dims = 1:ncol(scaall@reductions$nmf@feature.loadings))

pbmc3ki <- RunUMAP(pbmc3k, reduction = "nmf", reduction.name = "umap_nmf", dims = 1:ncol(pbmc3k@reductions$nmf@feature.loadings))


plot_grid(DimPlot(pbmc3ki, reduction = "umap_nmf", group.by = "cell_type"), DimPlot(scaally, reduction = "umap_nmf_rescaled", group.by = "cell_type"), ncol = 2)

```

Using threshold of 0.2
```{r}
# Feature.loading 
feat = c('AGRN','ACAP3','DVL1')
scaall<- rescale_nmf(pbmc3k,feat,0.2,reduction.key = "nmf_rescaled")
str(scaall)


scaally <- RunUMAP(scaall, reduction = "nmf_rescaled", reduction.name = "umap_nmf_rescaled", dims = 1:ncol(scaall@reductions$nmf@feature.loadings))

pbmc3ki <- RunUMAP(pbmc3k, reduction = "nmf", reduction.name = "umap_nmf", dims = 1:ncol(pbmc3k@reductions$nmf@feature.loadings))


plot_grid(DimPlot(pbmc3ki, reduction = "umap_nmf", group.by = "cell_type"), DimPlot(scaally, reduction = "umap_nmf_rescaled", group.by = "cell_type"), ncol = 2)
```


