---
title: "Rescaling of cell and genes features"
author: "Benjamin Arthur"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Rescaling of cell and genes features}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


## Introduction

The purpose of this package is to rescale cell or gene features from a seurat object which has been normalized and RunNMF has being implemented.

The library and object for rescaling can be found in the singlet package.

```{r}
library(singlet)
library(ggplot2)
library(dplyr)
library(cowplot)
pbmc3k <- get_pbmc3k_data()
pbmc3k <- pbmc3k %>% NormalizeData() %>% RunNMF(reps = 1)
```



## Recaling of a gene features with different threshold (Lambda)

In this example we used four genes of interest with 0.8 threshold, and we assume that using a threshold which is close to 1, the relationship between v and H would reduce.

From the plots below, the first UMAP visualized the genes features after rescaling and the second UMAP is visualizing the genes features with recaling.
```{r}
set.seed(542)
# Cell.embedding
cell = c("AACCGCCTCTACGAA","AACCTACTGTGAGG","AACCAGTGATACCG","AACACGTGGAAAGT")

pbmc3k <- RescaleNMF(pbmc3k,features=cell,reduction="nmf",lambda=0.8,reduction.name="nmf_rescaled")

model_reference <- RunUMAP(pbmc3k, reduction = "nmf", reduction.name = "umap_nmf", dims = 1:ncol(pbmc3k@reductions$nmf@cell.embeddings))

model_query <- RunUMAP(pbmc3k, reduction = "nmf_rescaled", reduction.name = "umap_nmf_rescaled", dims = 1:ncol(pbmc3k@reductions$nmf_rescaled@cell.embeddings))

plot_grid(DimPlot(model_reference, reduction = "umap_nmf", group.by = "cell_type"), DimPlot(model_query, reduction = "umap_nmf_rescaled", group.by = "cell_type"), ncol = 2)

```

Using threshold of about 0.2

```{r}
set.seed(542)
set.seed(542)
# Cell.embedding
cell = c("AACCGCCTCTACGAA","AACCTACTGTGAGG","AACCAGTGATACCG","AACACGTGGAAAGT")

pbmc3k <- RescaleNMF(pbmc3k,features=cell,reduction="nmf",lambda=0.2,reduction.name="nmf_rescaled")

model_reference <- RunUMAP(pbmc3k, reduction = "nmf", reduction.name = "umap_nmf", dims = 1:ncol(pbmc3k@reductions$nmf@cell.embeddings))

model_query <- RunUMAP(pbmc3k, reduction = "nmf_rescaled", reduction.name = "umap_nmf_rescaled", dims = 1:ncol(pbmc3k@reductions$nmf_rescaled@cell.embeddings))

plot_grid(DimPlot(model_reference, reduction = "umap_nmf", group.by = "cell_type"), DimPlot(model_query, reduction = "umap_nmf_rescaled", group.by = "cell_type"), ncol = 2)

```



## Recaling of a cell features with different threshold (Lambda)

In this example , we would checking the relationship between some selected genes (V) and
the H matrix from the reduction. Using threshold of 0.7.

From the plots below, the first UMAP visualized the cell features after rescaling and the second UMAP is visualizing the cells features with rescaling.
```{r}
# Feature Loading
gene = c('AGRN','ACAP3','DVL1')
pbmc3k <- RescaleNMF(pbmc3k,features=gene,reduction="nmf",lambda=0.7,reduction.name="nmf_rescaled")

model_reference <- RunUMAP(pbmc3k, reduction = "nmf", reduction.name = "umap_nmf", dims = 1:ncol(pbmc3k@reductions$nmf@feature.loadings))

model_query <- RunUMAP(pbmc3k, reduction = "nmf_rescaled", reduction.name = "umap_nmf_rescaled", dims = 1:ncol(pbmc3k@reductions$nmf_rescaled@feature.loadings))

plot_grid(DimPlot(model_reference, reduction = "umap_nmf", group.by = "cell_type"), DimPlot(model_query, reduction = "umap_nmf_rescaled", group.by = "cell_type"), ncol = 2)


```

Using threshold of 0.2
```{r}
# Feature.loading 
gene = c('AGRN','ACAP3','DVL1')

pbmc3k <- RescaleNMF(pbmc3k,features=gene,reduction="nmf",lambda=0.2,reduction.name="nmf_rescaled")

model_reference <- RunUMAP(pbmc3k, reduction = "nmf", reduction.name = "umap_nmf", dims = 1:ncol(pbmc3k@reductions$nmf@feature.loadings))

model_query <- RunUMAP(pbmc3k, reduction = "nmf_rescaled", reduction.name = "umap_nmf_rescaled", dims = 1:ncol(pbmc3k@reductions$nmf_rescaled@feature.loadings))

plot_grid(DimPlot(model_reference, reduction = "umap_nmf", group.by = "cell_type"), DimPlot(model_query, reduction = "umap_nmf_rescaled", group.by = "cell_type"), ncol = 2)

model_query@reductions$umap_nmf_rescaled$


```


